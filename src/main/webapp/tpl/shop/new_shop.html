<!-- 主界面 -->
<!--主模块-->
<section>
	<div id="div1">
		<div class="g-addshopbox f-mt-xl">
			<div class="g-addshop f-pt-s">
				<div class="col-xs-12 f-mb-l">
					<ul class="m-step-bar-box">
						<li class="first-step current-step">
							<label><span>1</span><i class="iconfont icon-avoid"></i></label>
							<h5>新增店铺资料</h5>
						</li>
						<li class="last-step">
							<label><span>2</span><i class="iconfont icon-avoid"></i></label>
							<h5>微信公众号授权</h5>
						</li>
					</ul>
				</div>
				<div class="col-xs-12" style="margin-bottom: 10px">
					<label class="u-lb-md c-black">店铺名称</label>
					<div class="u-txt col-xs-9">
						<input type="hidden" id="shopId" name="shopId" value="{{shop.shopId}}" />
						<input type="text" class="ipt-txt" placeholder="请输入店铺名称"  id="shopName" name="shopName" value="{{shop.shopName}}" />
					</div>
					<label class="u-lb-md c-black">主营商品</label>
					<div class="u-txt col-xs-9">
						<div class="ipt-txt c-gray1 u-bombbox-box">
							<input type="hidden" id="typeId" value="{{shop.shopType}}" />
							<span id="prname">{{cateName}}<i class="iconfont icon-down"></i></span>
							<ul class="u-bombbox" id="prtype">
								{% for item in shopCategorys %}
								<li data-id="{{item.typeId}}">{{item.typeName}}</li>
								{% endfor %}
							</ul>
						</div>
					</div>
					.
					<label class="u-lb-md c-black">店铺地址</label>
					<div id="distpicker" >
						<div class="u-txt col-xs-3">
							<select class="ipt-txt c-gray1" id="province" >
								<option>省</option>
							</select>
						</div>
						<div class="u-txt col-xs-3">
							<select class="ipt-txt c-gray1" id="city" >
								<option>市</option>
							</select>
						</div>
						<div class="u-txt col-xs-3">
							<select class="ipt-txt c-gray1"  id="district">
								<option>区</option>
							</select>
						</div>
					</div>

					<label class="u-lb-md c-black">详细地址</label>
					<div class="u-txt col-xs-9">
						<textarea class="ipt-txt txtarea" placeholder="请输入详细地址" id="specificAddr" name="specificAddr" >{{shop.specificAddr}}</textarea>
					</div>
				</div>

			</div>
		</div>
		<div class="u-btn-box1">
			<div class="u-cb bg-white">
				<input type="checkbox" name="quota" id="checkBox1" value=""/>
				<label class="iconfont icon-avoid" for="checkBox1"></label>
			</div>
			<label for="checkBox1">我已阅读并同意<font class="c-gray1">《聚米为谷商家版代理销售服务和结算协议、担保交易服务协议》</font></label>
		</div>

		<div class="u-btn-box"><input type="button" class="u-btn-lgdkorg" value="下一步" id="addshop" /></div>
	</div>


	<div id="div2"  style="display:none"  >
		<div class="g-addshopbox f-mt-xl">
			<div class="g-addshop f-pt-s">
				<div class="col-xs-12 f-mb-xxl">
					<ul class="m-step-bar-box">
						<li class="first-step">
							<label><span>1</span><i class="iconfont icon-avoid"></i></label>
							<h5>新增店铺资料</h5>
						</li>
						<li class="last-step current-step">
							<label><span>2</span><i class="iconfont icon-avoid"></i></label>
							<h5>微信公众号授权</h5>
						</li>
					</ul>
				</div>
				<div class="col-xs-12 f-tc f-mb-xl">
					<div class="u-wx-point f-mb-l">
						<p>绑定微信公众号，把店铺和微信打通</p>
						<p>绑定后即可在这里管理您的公众号，聚米为谷提供比微信官方更强大的功能</p>
					</div>
					<div class="u-btn-weixin"  id="show-qrcode1" ><i class="iconfont icon-wechat"></i>我有微信公众号，立即授权<i class="iconfont icon-ensure"></i></div>
					<div class="u-btn-weixin" id="show-qrcode2" style="display: none" ><i class="iconfont icon-wechat" ></i>再次授权<i class="iconfont icon-ensure"></i></div>
				</div>
				<dl class="col-xs-11 u-wx-explain f-mb-l" id="aginDl1">
					<dt>温馨说明：</dt>
					<dd>1、公众号需为认证期内的服务号，非此类公众号无法调用聚米为谷商城系统使用；请注意公众号每年年检正常，合格公众号请点击　　<a href="#">如何查看</a></dd>
					<dd>2、授权绑定成功后，聚米为谷将根据您经营的行业和商品，自动推送推荐使用的公众号菜单替换您原有的公众号菜单设置；请确认您现有公众号菜单可替换再进行重新授权！</dd>
					<dd>3、授权绑定成功后，您便可以在店铺管理里管理您的公众号和商城系统，聚米为谷为您提供强大的功能及性能保障！</dd>
					<dd>4、使用聚米为谷微信商场系统，请勿频繁授权给其他第三方微信商城系统，以便保障您日常正常使用及客户交易安全！</dd>
					<dd>5、公众号授权绑定成功，您所新建的店铺才能启用，您方可进入聚米为谷为你打造的移动电商系统！</dd>
					<dd>6、公众授权成功，店铺即创建成功，请注意店铺商城的支付设置！</dd>
				</dl>
				<dl class="col-xs-11 u-wx-explain f-mb-l" id="aginDl2" style="display: none">
					<dt>温馨说明：</dt>
					<dd>1、本次授权绑定未成功，可能因各种原因产生绑定失败，请自行排查！查看绑定失败原因请点击　　<a href="#">查看失败原因</a></dd>
					<dd>2、如各种原因所描述问题均不存在，可能因系统缓冲原因产生绑定失败，请点击上方再次授权！</dd>
					<dd>3、公众号授权绑定成功，您所新建的店铺才能启用，您方可进入聚米为谷为你打造的移动电商系统！</dd>
				</dl>
			</div>
		</div>
		<div class="u-btn-box">
			<input type="button" class="u-btn-lgdkorg" value="上一步" name="topbtn"  />
		</div>
	</div>



	<div id="div3"  style="display:none"  >
		<div class="g-addshopbox f-mt-xl">
			<div class="g-addshop f-pt-s">
				<div class="col-xs-12 f-mb-xxl">
					<ul class="m-step-bar-box">
						<li class="first-step">
							<label><span>1</span><i class="iconfont icon-avoid"></i></label>
							<h5>新增店铺资料</h5>
						</li>
						<li class="last-step current-step">
							<label><span>2</span><i class="iconfont icon-avoid"></i></label>
							<h5>微信公众号授权</h5>
						</li>
					</ul>
				</div>
				<div class="col-xs-12 f-tc f-mb-xl">
					<div class="u-wx-point f-mb-l">
						<p>绑定微信公众号，把店铺和微信打通</p>
						<p>绑定后即可在这里管理您的公众号，聚米为谷提供比微信官方更强大的功能</p>
					</div>
					<div class="u-btn-weixin"><i class="iconfont icon-wechat"></i>再次授权<i class="iconfont icon-ensure"></i></div>
				</div>
				<dl class="col-xs-11 u-wx-explain f-mb-l">
					<dt>温馨说明：</dt>
					<dd>1、本次授权绑定未成功，可能因各种原因产生绑定失败，请自行排查！查看绑定失败原因请点击　　<a href="#">查看失败原因</a></dd>
					<dd>2、如各种原因所描述问题均不存在，可能因系统缓冲原因产生绑定失败，请点击上方再次授权！</dd>
					<dd>3、公众号授权绑定成功，您所新建的店铺才能启用，您方可进入聚米为谷为你打造的移动电商系统！</dd>
				</dl>
			</div>
		</div>
		<div class="u-btn-box">
			<input type="button" class="u-btn-lgdkorg" value="上一步" name="topbtn"  />
			<input type="button" class="u-btn-lgdkorg" value="完成" name="okbtn" />
		</div>
	</div>

</section>
<!--/主模块-->
<!-- /主界面 -->
<div id="dialoginfo" class="dialoginfo">
	<div class="m-appling">
		<h3>你已成功提交申请</h3>
		<img src="{{globalUrl}}/img/pc/jmtool2.png"  />
		<p>三个工作日内，工作人员将与您电话确认，敬请保持手机接听畅通</p>
		<label>聚米为谷全国统一服务电话：<span>400-0766-568</span></label>
		<div class="u-btn-box1 f-mt-m"><input type="button" class="u-btn-mddkorg" value="我知道了" /></div>
	</div>
</div>
<div id="dialoginfo1" class="dialoginfo dhk" style="display: none;">
	<div class="select dialog-js login-tc">
		<div class="dialog-jsimg"></div>
		<div class="dialog-jstxt1 text-center"><span class="login-tis">在新窗口中完成微信公众号授权</span></div>
	</div>
</div>
<div id="dialoginfo2" class="dialoginfo m-wx-sus">
	<div class="m-sus-box">
		<img class="f-fl" src="{{globalUrl}}/img/pc/jmtool22.png" />
		<span class="f-pt-m">
					恭喜您，店铺创建成功<br />
					<em>公众号已授权绑定成功</em>
				</span>
	</div>
	<div class="u-btn-box1">
		系统　<font id="jumpTo">5</font>　秒后自动跳转进入店铺
	</div>
</div>
<div id="dialoginfo3" class="dialoginfo m-wx-sus">
	<div class="m-sus-box">
		<img class="f-fl" src="{{globalUrl}}/img/pc/jmtool33.png" />
		<span class="f-pt-m">
					很抱歉，店铺无法创建<br />
					<em>公众号授权绑定未成功</em>
				</span>
	</div>
	<div class="u-btn-box1">
		请关闭本页面后，查看并排查失败原因后再次授权
	</div>
</div>
<script>
	var shopid=0;
	$(document).ready(function() {
		$(".u-btn-weixin").click(function(){
			window.open('{{CONTEXT_PATH}}/auth/page1?shopId='+shopid);
			var elem = document.getElementById('dialoginfo1');
			dialog({
				title: "提示",
				content: elem,
				cancelValue: '重新授权',
				cancel: function () {

				},
				okValue: '授权已完成',
				ok: function() {
					//var shopid = $("#shopId").val();
					var okurl="{{CONTEXT_PATH}}/shop/okshop/"+shopid;
					$.ajaxJson(okurl,"",{
						"done":function (res) {
							console.log(res.data.code);
							if(res.data.code==0){//成功
								var elem1 = document.getElementById('dialoginfo2');
								dialog({
									title: "",
									content: elem1,
								}).width(430).showModal();

								//向微信公众号表内插入数据
								countDown(5,"{{CONTEXT_PATH}}/shop");
							}else{ //授权未成功
								$("#show-qrcode1").hide();
								$("#aginDl1").hide();
								$("#show-qrcode2").show();
								$("#aginDl2").show();
								var elem = document.getElementById('dialoginfo3');
								dialog({
									title: "提示",
									content: elem,
									okValue: '关闭',
									ok: function() {
									}
								}).width(500).height(150).showModal();
							}
						}
					});

				}
			}).width(500).height(150).showModal();

		});

		//创建店铺
		$("#addshop").click(function() {
			if( $("#checkBox1").is(":checked")==false){
				alert("请勾选聚米为谷服务协议！");
				return;
			}
			var shopId = $("#shopId").val();
			var shopName = $("#shopName").val();
			var typeId = $("#typeId").val();
			var specificAddr = $("#specificAddr").val();
			var provinceCode=$("#province").find("option:selected").attr('data-code');
			var cityCode=$("#city").find("option:selected").attr('data-code');
			var districtCode=$("#district").find("option:selected").attr('data-code');
			var province=$("#province").val();
			var city=$("#city").val();
			var district=$("#district").val();
			if(shopName==""){
				errMsg("请填写店铺名称！");
				return;
			}
			if(typeId==""){
				errMsg("请选择主营类目！");
				return;
			}
			if(specificAddr==""){
				errMsg("请填写详细地址！");
				return;
			}
			if(province==""){
				errMsg("请选择省份！");
				return;
			}
			if(city==""){
				errMsg("请选择城市！");
				return;
			}
			if(district==""){
				errMsg("请选择地区！");
				return;
			}
			var dataVo = {};
			dataVo.provinceCode=provinceCode;
			dataVo.cityCode=cityCode;
			dataVo.districtCode=districtCode;
			dataVo.province=province;
			dataVo.city=city;
			dataVo.district = district;
			dataVo.shopName = shopName;
			dataVo.shopType = typeId;
			dataVo.specificAddr = specificAddr;
			dataVo.shopId = shopId;
			var data = JSON.stringify(dataVo);
			var istrue=ajaxPost('{{CONTEXT_PATH}}/createshop',data);
			if(istrue){
				$("#div1").hide();
				$("#div2").show();
			}

		});

		//选择主营商品
		$("#prtype li").click(function() {
			var text = $(this).text();
			var id = $(this).attr("data-id");
			$("#prname").text(text);
			$("#typeId").val(id);
		});

		//上一步
		$("input[name$='topbtn']").click(function() {
			$("#div1").show();
			$("#div2").hide();
		});

		//完成按钮
		$("input[name$='okbtn']").click(function() {

		});


	});



	function ajaxPost(url,data){
		$(".loading").show();
		var istrue = false;
		$.ajax({
			type : 'POST',
			contentType : 'application/json',
			url:url,
			processData : false,
			async:false,
			dataType : 'json',
			data : data,
			success : function(data) {
				if(data.code==0){
					shopid=data.msg;
					istrue = true;
				}else{
					var dm = new dialogMessage({
						type:1,
						title:'操作提醒',
						fixed:true,
						msg:data.cause,
						isAutoDisplay:false
					});
					dm.render();
					istrue = false;
				}
				$(".loading").hide();
			}
		});
		return istrue;
	}

	function countDown(secs,surl){
		var jumpTo = document.getElementById('jumpTo');
		jumpTo.innerHTML=secs;
		if(--secs>-1){
			setTimeout("countDown("+secs+",'"+surl+"')",1000);
		}
		else{
			location.href=surl;
		}
	}

	function errMsg(data){
		var dm = new dialogMessage({
			type:2,
			title:'操作提醒',
			fixed:true,
			msg:data,
			isAutoDisplay:false
		});
		dm.render();
	}


	//********************初始化地区控件
	var chooseArea = function(){
	};
	chooseArea.prototype = {
		init:function(){
			this._renderArea();
		},
		_renderArea:function(){
			var $distpicker = $('#distpicker');
			$distpicker.distpicker({
				province:"{{shop.province}}",
				city: "{{shop.city}}",
				district: "{{shop.district}}",
				autoSelect: false
			});
		},
		_onBindClick:function(){


		},
		_offBindClick:function(){

		}
	};
	var choosearea = new chooseArea();
	choosearea.init();
	//********************初始化地区控件
</script>
